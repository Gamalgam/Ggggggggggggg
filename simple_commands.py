
from telegram import ParseMode, InlineKeyboardMarkup, \
    InlineKeyboardButton, Update

from telegram import ParseMode, Update
from telegram.ext import CommandHandler, CallbackContext
from asyncio import sleep
from user_setting import UserSetting
from utils import send_async
from shared_vars import dispatcher
from internationalization import _, user_locale
from contextlib import suppress
import subprocess
import time

ADMIN = 7386549277


@user_locale
def help_handler(update: Update, context: CallbackContext):
    """ูุนุงูุฌ ูุฃูุฑ /help"""
    help_text = _(
"""<b>ุงุชุจุน ูุฐู ุงูุฎุทูุงุช:</b>
1. ุฃุถู ูุฐุง ุงูุจูุช ุฅูู ุงููุฌููุนุฉ
2. ูู ุงููุฌููุนุฉุ ุงุจุฏุฃ ูุนุจุฉ ุฌุฏูุฏุฉ ุจุงุณุชุฎุฏุงู /new ุฃู ุงูุถู ุฅูู ูุนุจุฉ ููุฌูุฏุฉ ุจุงููุนู
ุงุจุฏุฃ ุงููุนุจุฉ ุจู /join
ยซ3. ุจุนุฏ ุงูุถูุงู ูุงุนุจูู ุนูู ุงูุฃููุ ุงุจุฏุฃ ุงููุนุจุฉ ุจุงุณุชุฎุฏุงูยป
/go
4. ุฃุฏุฎู <code>@uno113bot</code> ูู ูุงูุฐุฉ ุงูุฏุฑุฏุดุฉ ูุงุถุบุท ุนูู <b>ูุณุงูุฉ</b>. 
ุณุชุฑู ุจุทุงูุงุชู (ุชู ุชูููุฒ ุจุนุถูุง ุจุงูููู ุงูุฑูุงุฏู)ุ 
ุฃู ุฎูุงุฑุงุช ุฅุถุงููุฉุ ูุซู ุงูุฑุณู ู <b>?</b> ูุฑุคูุฉ 
ุงูุญุงูุฉ ุงูุญุงููุฉ ููุนุจุฉ. <b>ุงูุจุทุงูุงุช ุงูุฑูุงุฏูุฉ</b> ูู ุชูู ุงูุชู 
<b>ูุง ูููู ูุนุจูุง</b> ูู ุงูููุช ุงูุญุงูู. 
ุงุถุบุท ุนูู ุงูุฎูุงุฑ ูุชูููุฐ 
ุงูุฅุฌุฑุงุก ุงููุฎุชุงุฑ.
ูููู ููุงุนุจูู ุงูุงูุถูุงู ุฅูู ุงููุนุจุฉ ูู ุฃู ููุช. (ุฅุฐุง ูุงูุช ุงููุนุจุฉ ููุชูุญุฉ)
ููุบุงุฏุฑุฉ ุงููุนุจุฉุ ุงุณุชุฎุฏู /leave. 
ุฅุฐุง ุงุณุชุบุฑู ุงููุงุนุจ ุฃูุซุฑ ูู 90 ุซุงููุฉ ููุนุจุ 
ููููู ุงุณุชุฎุฏุงู /skip ูุชุฎุทู ูุฐุง ุงููุงุนุจ. 
ุงุณุชุฎุฏู /notify_me ูุชููู ุฑุณุงูุฉ ุดุฎุตูุฉ ุนูุฏ ุจุฏุก ูุนุจุฉ ุฌุฏูุฏุฉ.


<b>ุงูุฅุญุตุงุฆูุงุช:</b>
/stats - ุนุฑุถ ุฅุญุตุงุฆูุงุช ุฃูุนุงุจู
/delstats - ุญุฐู ุฅุญุตุงุฆูุงุช ุฃูุนุงุจู

<b>ุฃูุงูุฑ ุฃุฎุฑู (ููุท ูููุดุฆ ุงููุนุจุฉ):</b>
/close - ุฅุบูุงู ุงูููุจู
/open - ูุชุญ ุงูููุจู
/kill - ุฅููุงุก ุงููุนุจุฉ
/kick - ุทุฑุฏ ูุงุนุจ ูู ุงููุนุจุฉ 
(ุฑุฏูุง ุนูู ุฑุณุงูุฉ ุงููุณุชุฎุฏู)""")
    send_async(context.bot, update.message.chat_id, text=help_text,
               parse_mode=ParseMode.HTML, disable_web_page_preview=True)



@user_locale
def modes(update: Update, context: CallbackContext):
    """ูุนุงูุฌ ูุฃูุฑ /help"""
    modes_explanation = _(
"""
<b>ูุญุชูู ูุฐุง ุงูุฑูุจูุช UNO ุนูู ุนุฏุฉ ุฃูุถุงุน ููุนุจุฉ</b>:
๐ปูู ุงููุถุน ุงูููุงุณูููุ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑู UNO ุงูุนุงุฏูุฉ ููุง ููุฌุฏ ุชุฎุทู ุชููุงุฆู.
๐ขูู ูุถุน "<b>ุงูุฃุฑูุงู</b>"ุ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑู UNO ุจุฏูู ุงูุฃูุฑุงู ุงูุฎุงุตุฉ ููุง ููุฌุฏ ุชุฎุทู ุชููุงุฆู.
๐ูู ูุถุน "<b>ุงูุนูุณ</b>"ุ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑู UNO ุงูุนุงุฏูุฉุ ููู ูุชู ุนูุณ ูู ุงูุฅุฌุฑุงุกุงุชุ ููุง ููุฌุฏ ุชุฎุทู ุชููุงุฆู.
๐ปูู ุงููุถุน ุงูููุงุณูููุ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑู UNO ุงูุนุงุฏูุฉ ููุง ููุฌุฏ ุชุฎุทู ุชููุงุฆู.
๐ูู ูุถุน "<b>ุงูุณุฑูุน</b>"ุ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑู UNO ุงูุนุงุฏูุฉุ ููุชู ุชุฎุทู ุงููุงุนุจ ุชููุงุฆููุง ุฅุฐุง ุชุฃุฎุฑ ูุซูุฑูุง ูู ูุนุจ ุฏูุฑู.
๐ูู ูุถุน "<b>ุงูุทุจูุนุฉ ุงูุจุฑูุฉ</b>"ุ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑู ุชุญุชูู ุนูู ุงูุนุฏูุฏ ูู ุงูุฃูุฑุงู ุงูุฎุงุตุฉุ ูุชููุน ุฃูู ูู ุงูุฃุฑูุงูุ ุจุฏูู ุชุฎุทู ุชููุงุฆู.
๐ฅ๐ูู ูุถุน "<b>ุงูุทุจูุนุฉ ุงูุจุฑูุฉ ุงูุฎุทูุฑุฉ</b>"ุ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ุฃูุฑุงู ุชุญุชูู ููุท ุนูู ุงูุฃูุฑุงู ุงูุฎุงุตุฉ.
๐ูู ูุถุน "<b>ุงูุนุงูู ุงููุจูุฑ</b>"ุ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑู UNO ุงูุนุงุฏูุฉุ ูููู ูู ุจุฏุงูุฉ ุงููุนุจุฉ ูุชู ุชูุฒูุน <b>ุงููุซูุฑ</b> ูู ุงูุฃูุฑุงู.
๐๐ูู ูุถุน "<b>ุงูุนุงูู ุงูุจุฑู ุงููุจูุฑ</b>"ุ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑู ุชุญุชูู ุนูู ุงูุนุฏูุฏ ูู ุงูุฃูุฑุงู ุงูุฎุงุตุฉุ ูุชูุฒูุน ูููุงุช ูุจูุฑุฉ ูู ุงูุฃูุฑุงู ูู ุงูุจุฏุงูุฉ. ุจุฏูู ุชุฎุทู ุชููุงุฆู.
๐โ๏ธูู ูุถุน "<b>ุงูุนุงูู ุงููุงุจู ููุชุฎุตูุต</b>"ุ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑู UNO ุงูุนุงุฏูุฉุ ูููู ูู ุจุฏุงูุฉ ุงููุนุจุฉ ูุชู ุชูุฒูุน ุงูุนุฏุฏ ุงูุฐู ุชุญุฏุฏู ูู ุงูุฃูุฑุงู (ุจุญุฏ ุฃูุตู 35).
๐ชูู ูุถุน "<b>ุงูุนุงูู ุงูุนุดูุงุฆู</b>"ุ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุฉ ูุฑู UNO ุงูุนุงุฏูุฉุ ูููู ูู ูู ุฌููุฉ ุชุชุบูุฑ ุฃูุฑุงู ุงููุงุนุจูู!
(<b>ููุง ุฃู ููู ูุฐู ุงูุฃูุถุงุน ูุณุฎุฉ ูุตูุฉ โ๏ธ</b>)

<b>ุฃูุถูุงุ ูุญุชูู ูุฐุง ุงูุฑูุจูุช ุนูู ุนุฏุฉ ุฃููุงุน ูู ุงูุฃูุนุงุจ</b>:
"<b>๐ค ุงูุฃูุฑุงู ุงูุจูุถุงุก</b>" - ูู ูุฐุง ุงูููุน ูู ุงููุนุจุฉ ูุชู ุงุณุชุฎุฏุงู ุงูุฃูุฑุงู ุงูุนุงุฏูุฉ ุงูุจูุถุงุก.
"<b>๐ค ุงูุฃูุฑุงู ุงูุณูุฏุงุก</b>" - ูู ูุฐุง ุงูููุน ูู ุงููุนุจุฉ ูุชู ุงุณุชุฎุฏุงู ุงูุฃูุฑุงู ุงูุณูุฏุงุก ุบูุฑ ุงูุชูููุฏูุฉ.
"<b>๐ ุฃูุฑุงู Flip</b>" - ูู ูุฐุง ุงูููุน ูู ุงููุนุจุฉ ูุชู ุงุณุชุฎุฏุงู ูุฌููุนุชูู ูู ุงูุฃูุฑุงู ูู ููุณ ุงูููุช!
<i>ูุชุบููุฑ ุงููุฌููุนุฉุ ูุฌุจ ุฃู ุชูุนุจ ุจูุฑูุฉ ุฎุงุตุฉุ ูุจุนุฏ ุฐูู ูุญุฏุซ "ุชุจุฏูู" ูุชุชุญูู ุงูุฃูุฑุงู.</i>

<b><i>ูุงุญุธ ุฃูู ุฅุฐุง ุฌูุนุช ุฃูุซุฑ ูู 45 ูุฑูุฉุ ุณุชุฎุณุฑ!</i></b>
ูุชุบููุฑ ูุถุน ุงููุนุจุฉุ ูุฌุจ ุนูู <u>ููุดุฆ ุงููุนุจุฉ</u> ุฅุฏุฎุงู ุงุณู ุงูุฑูุจูุช ููุณุงูุฉุ ุชูุงููุง ููุง ูุชู ูุนุจ ูุฑูุฉุ ูุณุชุธูุฑ ุฌููุน ุฎูุงุฑุงุช ูุถุน ุงููุนุจุฉ.
(<i>ุฃู ููููู ุงุณุชุฎุฏุงู ุงูุฃุฒุฑุงุฑ ุงูุชู ุชุธูุฑ ุนูุฏ ุฅูุดุงุก ูุนุจุฉ ุฌุฏูุฏุฉ</i>)
""")
    
    send_async(context.bot, update.message.chat_id, text=modes_explanation,
               parse_mode=ParseMode.HTML, disable_web_page_preview=True)

@user_locale
def source(update: Update, context: CallbackContext):
    """ูุนุงูุฌ ูุฃูุฑ /help"""
    source_text = _('ูุฐุง ุงูุฑูุจูุช ูู ูุณุฎุฉ ูู ุจุฑูุงูุฌ ูุฌุงูู. ููุฎุถุน ูุชุฑุฎูุต "<b>AGPL</b>".\n'
      "<b>ุงูููุฏ ุงูุฃุตูู ูุชุงุญ ููุง:</b> \n"
      "https://github.com/Dimoka113/Uno113bot")
    attributions = _("ุงููุณุจ:\n"
      '"<b>ุฑูุฒ Draw ูู:</b> '
      '<a href="http://www.faithtoken.com/">Faithtoken</a>\n'
      '"<b>ุฑูุฒ Pass ูู:</b> '
      '<a href="http://delapouite.com/">Delapouite</a>\n'
      "ุงููุณุฎ ุงูุฃุตููุฉ ูุชุงุญุฉ ุนูู: http://game-icons.net\n"
      "ุงูุฃููููุงุชุ ุงููุญุฑุฑุฉ ุจูุงุณุทุฉ <b>ษณick</b>\n"
      "ุงูุชุฑุฌูุฉ ุฅูู ุงูุฑูุณูุฉุ <a href='https://www.unorules.com/uno-flip-rules/'>uno flip</a> ูุงูุชุตุญูุญ: <a href='https://t.me/This113bots'>This113bots</a>\n"
      "ุดูุฑ ุฎุงุต ูู: <a href='tg://user?id=1956508438'>MrKoteyka</a>")

    send_async(context.bot, update.message.chat_id, text=source_text + '\n' +
                                                 attributions,
               parse_mode=ParseMode.HTML, disable_web_page_preview=True)


@user_locale
def news(update: Update, context: CallbackContext):
    """ูุนุงูุฌ ูุฃูุฑ /news"""
    chat = update.message.chat
    ping = [[InlineKeyboardButton(text=_("๐จโ๐ปThis113bots"), url='https://t.me/This113bots')]]
    send_async(context.bot, chat.id,      
                    text=_("ููููู ูุฑุงุกุฉ ุฃุฎุจุงุฑ ุงูุจูุชุงุช ููุง ๐"),
                      reply_markup=InlineKeyboardMarkup(ping),
                      parse_mode=ParseMode.HTML)


@user_locale
def stats(update: Update, context: CallbackContext):
    user = update.message.from_user
    chat = update.message.chat
    us = UserSetting.get(id=user.id)
    if not us or not us.stats:
          ping = [[InlineKeyboardButton(text=_("ุชูุนูู ุงูุฅุญุตุงุกุงุช!"), url='https://t.me/Uno113bot?start=stats_add')]]
          send_async(context.bot, chat.id,      
                    text=_("ูุฑุฌู ุชูุนูู ุงูุฅุญุตุงุกุงุช ูู ุงูุฏุฑุฏุดุฉ ุงูุฎุงุตุฉ ูุน ุงูุจูุช."),
                      reply_to_message_id=update.message.message_id,
                      reply_markup=InlineKeyboardMarkup(ping),
                      parse_mode=ParseMode.HTML)

    else:
        stats_text = list()

        n = us.games_played
        stats_text.append(
            _("ุงูุฃูุนุงุจ ุงูุชู ุชู ูุนุจูุง: {number}",
              "ุงูุฃูุนุงุจ ุงูุชู ุชู ูุนุจูุง: {number}",
              n).format(number=n)
        )

        n = us.first_places
        m = round((us.first_places / us.games_played) * 100) if us.games_played else 0
        stats_text.append(
            _("ุงูุฃูุนุงุจ ุงูุชู ุชู ุงูููุฒ ุจูุง: {number}. ({percent}%)",
              "ุงูุฃูุนุงุจ ุงูุชู ุชู ุงูููุฒ ุจูุง: {number}. ({percent}%)",
              n).format(number=n, percent=m)
        )

        n = us.cards_played
        stats_text.append(
            _("ุงูุจุทุงูุงุช ุงููุณุชุฎุฏูุฉ: {number}",
              "ุงูุจุทุงูุงุช ุงููุณุชุฎุฏูุฉ: {number}",
              n).format(number=n)
        )

        send_async(context.bot, update.message.chat_id,
                   text='\n'.join(stats_text))





def register():
    dispatcher.add_handler(CommandHandler('help', help_handler))
    dispatcher.add_handler(CommandHandler('source', source))
    dispatcher.add_handler(CommandHandler('news', news))
    dispatcher.add_handler(CommandHandler('stats', stats))
    dispatcher.add_handler(CommandHandler('modes', modes))
